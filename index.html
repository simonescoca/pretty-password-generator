<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Courier+Prime&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    />
    <style>
      header > .container {
        height: 100px;
      }
      header #Switch-container {
        height: 40px;
        width: 70px;
      }
      header #Switch {
        height: 35px;
        width: 35px;
        top: 50%;
        left: 1.5px;
        transform: translateY(-50%);
      }
      main > .container {
        height: calc(100vh - 4rem - 150px);
      }
      main #Slider-pill #Pw-display {
        font-family: "Courier Prime", monospace;
        font-size: 21px;
      }
      @media screen and (max-width: 575px) {
        #Slider-pill {
          height: 100%;
          width: 70px;
        }
        #Slider-pill .rounded-circle {
          width: 100%;
          height: 70px;
        }
        #Pw-display {
          height: calc(100% - 140px);
          width: 100%;
        }
      }
      @media screen and (min-width: 576px) {
        #Slider-pill {
          height: 70px;
          width: 100%;
        }
        #Slider-pill .rounded-circle {
          height: 100%;
          width: 70px;
        }
        #Pw-display {
          width: calc(100% - 140px);
          height: 100%;
        }
      }
      @media screen and (min-width: 768px) {
        #Slider-pill {
          width: 560px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div
        class="d-flex container justify-content-between align-items-center border border-dark mt-3"
      >
        <h1 class="Title">Password Generator</h1>
        <div>
          <label
            id="Switch-container"
            for="Mode-button"
            class="border border-primary rounded-pill position-relative"
          >
            <div
              id="Switch"
              class="border border-primary rounded-circle d-flex justify-content-center align-items-center position-absolute"
            >
              <!-- icon -->
            </div>
          </label>
          <input type="checkbox" id="Mode-button" class="d-none" />
        </div>
      </div>
    </header>
    <main>
      <div class="d-flex container border border-primary mt-1">
        <div
          id="Slider-pill"
          class="m-auto mx-sm-auto mt-sm-3 border border-danger rounded-pill d-flex flex-column flex-sm-row justify-content-between align-items-center position-relative"
        >
          <div id="Slider" class="bg-danger rounded-circle position-absolute"></div>
          <div id="Copy" class="border border-primary rounded-circle"></div>
          <div
            id="Pw-display"
            class="border border-success rounded d-flex flex-column flex-sm-row align-items-stretch"
          >
            <section
              class="Block border border-danger rounded flex-fill d-flex justify-content-center align-items-center"
            >
              1111
            </section>
            <section
              class="Block border border-danger rounded flex-fill d-flex justify-content-center align-items-center"
            >
              2222
            </section>
            <section
              class="Block border border-danger rounded flex-fill d-flex justify-content-center align-items-center"
            >
              3333
            </section>
            <section
              class="Block border border-danger rounded flex-fill d-flex justify-content-center align-items-center"
            >
              4444
            </section>
            <section
              class="Block border border-danger rounded flex-fill d-flex justify-content-center align-items-center"
            >
              5555
            </section>
          </div>
          <div class="border border-primary rounded-circle"></div>
        </div>
      </div>
    </main>
    <script>
      // Dichiarazioni e inizializzazioni delle variabili
      const slider = document.getElementById("Slider");
      const sliderPill = document.getElementById("Slider-pill");
      const modeButton = document.getElementById("Mode-button");

      let isDragging = false;
      let dragAxis = window.innerWidth < 576 ? "vertical" : "horizontal";
      let startPointerPos = 0;
      let startSliderPos = 0;

      // Funzioni

      // Imposta la posizione iniziale dello slider (all'inizio della slider pill)
      function setInitialPosition() {
        dragAxis = window.innerWidth < 576 ? "vertical" : "horizontal";
        // Posizione iniziale: 0 rispetto a sliderPill
        slider.style.top = "0px";
        slider.style.left = "0px";
      }

      // Ritorna la posizione del puntatore (mouse o touch)
      function getPointerPosition(e) {
        if (e.touches) {
          return { x: e.touches[0].clientX, y: e.touches[0].clientY };
        } else {
          return { x: e.clientX, y: e.clientY };
        }
      }

      // Calcola e restituisce l'array delle posizioni di snap (livelli 0-5)
      // In modalità verticale: lo slider si ferma quando il suo bordo superiore tocca il bordo inferiore di ogni .Block
      // In modalità orizzontale: lo slider si ferma quando il suo bordo sinistro tocca il bordo destro di ogni .Block
      function getSnapPositions() {
        const pillRect = sliderPill.getBoundingClientRect();
        const pwDisplay = document.getElementById("Pw-display");
        const pwRect = pwDisplay.getBoundingClientRect();
        const blocks = document.querySelectorAll("#Pw-display .Block");
        let snaps = [];
        if (dragAxis === "vertical") {
          // Livello 0: posizione iniziale (0)
          snaps.push(0);
          // Livelli 1-5: per ogni block, la posizione in cui il bordo superiore dello slider
          // tocca il bordo inferiore del block
          blocks.forEach((block) => {
            const blockRect = block.getBoundingClientRect();
            snaps.push(blockRect.bottom - pillRect.top);
          });
        } else {
          // Livello 0: posizione iniziale (0)
          snaps.push(0);
          // Livelli 1-5: per ogni block, la posizione in cui il bordo sinistro dello slider
          // tocca il bordo destro del block
          blocks.forEach((block) => {
            const blockRect = block.getBoundingClientRect();
            snaps.push(blockRect.right - pillRect.left);
          });
        }
        return snaps; // [livello0, livello1, ..., livello5]
      }

      // Gestisce l'inizio del drag
      function dragStart(e) {
        e.preventDefault();
        isDragging = true;
        // Aggiorna l'asse in base alla viewport attuale
        dragAxis = window.innerWidth < 576 ? "vertical" : "horizontal";
        const pointerPos = getPointerPosition(e);
        if (dragAxis === "vertical") {
          startPointerPos = pointerPos.y;
          startSliderPos = parseInt(slider.style.top) || 0;
        } else {
          startPointerPos = pointerPos.x;
          startSliderPos = parseInt(slider.style.left) || 0;
        }
        document.addEventListener("mousemove", dragMove);
        document.addEventListener("mouseup", dragEnd);
        document.addEventListener("touchmove", dragMove, { passive: false });
        document.addEventListener("touchend", dragEnd);
      }

      // Gestisce il movimento del drag (con scatti)
      function dragMove(e) {
        if (!isDragging) return;
        e.preventDefault();
        const pointerPos = getPointerPosition(e);
        let delta =
          dragAxis === "vertical"
            ? pointerPos.y - startPointerPos
            : pointerPos.x - startPointerPos;
        let newPos = startSliderPos + delta;

        // Limita il movimento all'intervallo definito dai confini (snap positions)
        const snaps = getSnapPositions();
        const minPos = snaps[0];
        const maxPos = snaps[snaps.length - 1];
        if (newPos < minPos) newPos = minPos;
        if (newPos > maxPos) newPos = maxPos;

        if (dragAxis === "vertical") {
          slider.style.top = newPos + "px";
        } else {
          slider.style.left = newPos + "px";
        }
      }

      // Alla fine del drag, applica lo scatto allo snap più vicino rispetto alla posizione corrente
      function dragEnd(e) {
        isDragging = false;
        document.removeEventListener("mousemove", dragMove);
        document.removeEventListener("mouseup", dragEnd);
        document.removeEventListener("touchmove", dragMove);
        document.removeEventListener("touchend", dragEnd);

        const snaps = getSnapPositions();
        let currentPos =
          dragAxis === "vertical"
            ? parseInt(slider.style.top) || 0
            : parseInt(slider.style.left) || 0;
        let closestSnap = snaps[0];
        for (let i = 1; i < snaps.length; i++) {
          if (Math.abs(snaps[i] - currentPos) < Math.abs(closestSnap - currentPos)) {
            closestSnap = snaps[i];
          }
        }
        if (dragAxis === "vertical") {
          slider.style.top = closestSnap + "px";
        } else {
          slider.style.left = closestSnap + "px";
        }
      }

      // Event listeners
      window.addEventListener("resize", setInitialPosition);
      slider.addEventListener("mousedown", dragStart);
      slider.addEventListener("touchstart", dragStart, { passive: false });
      modeButton.addEventListener("click", () => {
        console.log(modeButton.checked);
      });

      // Posiziona lo slider al caricamento (all'inizio della slider pill)
      setInitialPosition();
    </script>
  </body>
</html>