<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Password Generator</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Courier+Prime&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    />
    <style>
      header > .container {
        height: 100px;
      }
      header #Switch-container {
        height: 40px;
        width: 70px;
      }
      header #Switch {
        height: 35px;
        width: 35px;
        top: 50%;
        left: 1.5px;
        transform: translateY(-50%);
      }
      main > .container {
        height: calc(100vh - 4rem - 150px);
      }
      main #Slider-pill #Pw-display {
        font-family: "Courier Prime", monospace;
        font-size: 21px;
      }
      @media screen and (max-width: 575px) {
        #Slider-pill {
          height: 100%;
          width: 70px;
        }
        #Slider-pill .rounded-circle {
          width: 100%;
          height: 70px;
        }
        #Pw-display {
          height: calc(100% - 140px);
          width: 100%;
        }
        #Pw-display .Block {
          width: 100%;
          height: 20%;
        }
        #Pw-display .Block:not(:last-child)::after {
          content: " ";
          display: table;
          position: absolute;
          bottom: -1px;
          left: 50%;
          transform: translate(-50%, 50%);
          background: black;
          height: 1.7px;
          width: 10px;
          border-radius: 1px;
        }
      }
      @media screen and (min-width: 576px) {
        #Slider-pill {
          height: 70px;
          width: 100%;
        }
        #Slider-pill .rounded-circle {
          height: 100%;
          width: 70px;
        }
        #Pw-display {
          width: calc(100% - 140px);
          height: 100%;
        }
        #Pw-display .Block {
          height: 100%;
          width: 20%;
        }
        #Pw-display .Block:not(:last-child)::after {
          content: " ";
          display: table;
          position: absolute;
          right: -1px;
          top: 50%;
          transform: translate(50%, -50%);
          background: black;
          height: 1.7px;
          width: 10px;
          border-radius: 1px;
        }
      }
      @media screen and (min-width: 768px) {
        #Slider-pill {
          width: 560px;
        }
      }
      /* Stile per il pop-up di notifica */
      #copyNotification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #d4edda;
        color: #155724;
        padding: 10px 20px;
        border-radius: 5px;
        border: 1px solid #c3e6cb;
        display: none;
        z-index: 9999;
        font-family: Arial, sans-serif;
        font-size: 16px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>
  <body>
    <header>
      <div
        class="d-flex container justify-content-between align-items-center border border-dark mt-3"
      >
        <h1 class="Title">Password Generator3</h1>
        <div>
          <label
            id="Switch-container"
            for="Mode-button"
            class="border border-primary rounded-pill position-relative"
          >
            <div
              id="Switch"
              class="border border-primary rounded-circle d-flex justify-content-center align-items-center position-absolute"
            >
              <!-- icon -->
            </div>
          </label>
          <input type="checkbox" id="Mode-button" class="d-none" />
        </div>
      </div>
    </header>
    <main>
      <div class="d-flex container border border-primary mt-1">
        <div
          id="Slider-pill"
          class="m-auto mx-sm-auto mt-sm-3 border border-danger rounded-pill d-flex flex-column flex-sm-row justify-content-between align-items-center position-relative"
        >
          <!-- Div per la copia (con tabindex per renderlo focusable) -->
          <div id="Copy" class="border border-primary rounded-circle" tabindex="0"></div>
          <div
            id="Pw-display"
            class="border border-success rounded d-sm-flex"
          >
            <section
              class="Block border border-danger rounded d-flex justify-content-center align-items-center position-relative"
            >
              1111
            </section>
            <section
              class="Block border border-danger rounded d-flex justify-content-center align-items-center position-relative"
            >
              2222
            </section>
            <section
              class="Block border border-danger rounded d-flex justify-content-center align-items-center position-relative"
            >
              3333
            </section>
            <section
              class="Block border border-danger rounded d-flex justify-content-center align-items-center position-relative"
            >
              4444
            </section>
            <section
              class="Block border border-danger rounded d-flex justify-content-center align-items-center position-relative"
            >
              5555
            </section>
          </div>
          <div class="border border-primary rounded-circle"></div>
          <div id="Slider" class="bg-danger rounded-circle position-absolute"></div>
        </div>
      </div>
    </main>
    <!-- Pop-up di notifica -->
    <div id="copyNotification">
      <i class="fas fa-check" style="margin-right: 8px;"></i> Password copiata
    </div>
    <script>
      // Dichiarazioni e inizializzazioni delle variabili
      const slider = document.getElementById("Slider");
      const sliderPill = document.getElementById("Slider-pill");
      const modeButton = document.getElementById("Mode-button");
      let currentLevel = 0;
      let isDragging = false;
      let dragAxis = window.innerWidth < 576 ? "vertical" : "horizontal";
      let startPointerPos = 0;
      let startSliderPos = 0;

      // FUNZIONI PER GENERARE LE PASSWORD
      function genRandomIndex(len) {
        const arr = new Uint32Array(1);
        window.crypto.getRandomValues(arr);
        return arr[0] % len;
      }

      function generatePw(level) {
        const ABC = "ABCDEFGHJKLMNPQRSTUVWXYZ".split("");
        const abc = "abcdefghijkmnopqrstuvwxyz".split("");
        const nums = "0123456789".split("");
        const chars = "!@#$%&*?.".split("");
        let password, checkCap, checkLow, checkNum, checkSC;
        do {
          password = "";
          checkCap = checkLow = checkNum = checkSC = false;
          for (let i = 0; i < 4 * level; i++) {
            const boundary = (i % 4 === 0 || i % 4 === 3);
            const options = boundary
              ? [
                  ABC[genRandomIndex(ABC.length)],
                  abc[genRandomIndex(abc.length)],
                  nums[genRandomIndex(nums.length)]
                ]
              : [
                  ABC[genRandomIndex(ABC.length)],
                  abc[genRandomIndex(abc.length)],
                  nums[genRandomIndex(nums.length)],
                  chars[genRandomIndex(chars.length)]
                ];
            const chosen = options[genRandomIndex(options.length)];
            password += chosen;
            if (ABC.includes(chosen)) checkCap = true;
            if (abc.includes(chosen)) checkLow = true;
            if (nums.includes(chosen)) checkNum = true;
            if (chars.includes(chosen)) checkSC = true;
          }
        } while (!(checkCap && checkLow && checkNum && checkSC));
        return password.match(/.{1,4}/g).join("-");
      }

      function updatePasswordDisplay(level) {
        const pwDisplay = document.getElementById("Pw-display");
        const blocks = pwDisplay.querySelectorAll(".Block");
        if (level === 0) {
          blocks.forEach((block) => (block.textContent = ""));
          return;
        }
        const password = generatePw(level);
        const groups = password.split("-");
        blocks.forEach((block, index) => {
          block.textContent = groups[index] || "";
        });
      }

      // FUNZIONI DI GESTIONE DELLO SLIDER
      function setInitialPosition() {
        dragAxis = window.innerWidth < 576 ? "vertical" : "horizontal";
        slider.style.top = "0px";
        slider.style.left = "0px";
        currentLevel = 0;
        updatePasswordDisplay(0);
      }

      function getPointerPosition(e) {
        if (e.touches) {
          return { x: e.touches[0].clientX, y: e.touches[0].clientY };
        } else {
          return { x: e.clientX, y: e.clientY };
        }
      }

      function getSnapPositions() {
        const pillRect = sliderPill.getBoundingClientRect();
        const blocks = document.querySelectorAll("#Pw-display .Block");
        let snaps = [];
        if (dragAxis === "vertical") {
          snaps.push(0);
          blocks.forEach((block) => {
            const blockRect = block.getBoundingClientRect();
            snaps.push(blockRect.bottom - pillRect.top);
          });
        } else {
          snaps.push(0);
          blocks.forEach((block) => {
            const blockRect = block.getBoundingClientRect();
            snaps.push(blockRect.right - pillRect.left);
          });
        }
        return snaps;
      }

      function dragStart(e) {
        e.preventDefault();
        isDragging = true;
        dragAxis = window.innerWidth < 576 ? "vertical" : "horizontal";
        const pointerPos = getPointerPosition(e);
        if (dragAxis === "vertical") {
          startPointerPos = pointerPos.y;
          startSliderPos = parseInt(slider.style.top) || 0;
        } else {
          startPointerPos = pointerPos.x;
          startSliderPos = parseInt(slider.style.left) || 0;
        }
        document.addEventListener("mousemove", dragMove);
        document.addEventListener("mouseup", dragEnd);
        document.addEventListener("touchmove", dragMove, { passive: false });
        document.addEventListener("touchend", dragEnd);
      }

      function dragMove(e) {
        if (!isDragging) return;
        e.preventDefault();
        const pointerPos = getPointerPosition(e);
        let delta = dragAxis === "vertical" ? pointerPos.y - startPointerPos : pointerPos.x - startPointerPos;
        let newPos = startSliderPos + delta;
        const snaps = getSnapPositions();
        const minPos = snaps[0];
        const maxPos = snaps[snaps.length - 1];
        if (newPos < minPos) newPos = minPos;
        if (newPos > maxPos) newPos = maxPos;
        if (dragAxis === "vertical") {
          slider.style.top = newPos + "px";
        } else {
          slider.style.left = newPos + "px";
        }
      }

      function dragEnd(e) {
        isDragging = false;
        document.removeEventListener("mousemove", dragMove);
        document.removeEventListener("mouseup", dragEnd);
        document.removeEventListener("touchmove", dragMove);
        document.removeEventListener("touchend", dragEnd);
        const snaps = getSnapPositions();
        let currentPos = dragAxis === "vertical" ? parseInt(slider.style.top) || 0 : parseInt(slider.style.left) || 0;
        let closestSnap = snaps[0];
        let closestIndex = 0;
        for (let i = 1; i < snaps.length; i++) {
          if (Math.abs(snaps[i] - currentPos) < Math.abs(closestSnap - currentPos)) {
            closestSnap = snaps[i];
            closestIndex = i;
          }
        }
        if (dragAxis === "vertical") {
          slider.style.top = closestSnap + "px";
        } else {
          slider.style.left = closestSnap + "px";
        }
        currentLevel = closestIndex;
        updatePasswordDisplay(closestIndex);
      }

      function moveSliderToLevel(newLevel) {
        const snaps = getSnapPositions();
        if (newLevel < 0) newLevel = 0;
        if (newLevel >= snaps.length) newLevel = snaps.length - 1;
        const axis = window.innerWidth < 576 ? "vertical" : "horizontal";
        if (axis === "vertical") {
          slider.style.top = snaps[newLevel] + "px";
        } else {
          slider.style.left = snaps[newLevel] + "px";
        }
        currentLevel = newLevel;
        updatePasswordDisplay(newLevel);
      }

      // Funzione per mostrare il pop-up di notifica per 2 secondi
      function showCopyNotification() {
        const notif = document.getElementById("copyNotification");
        notif.style.display = "block";
        setTimeout(() => {
          notif.style.display = "none";
        }, 2000);
      }

      // Fallback per copiare il testo (vecchio metodo) su dispositivi mobili
      function fallbackCopyTextToClipboard(text) {
        var textArea = document.createElement("textarea");
        textArea.value = text;
        // Evita lo scroll
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
          var successful = document.execCommand("copy");
          if (successful) {
            showCopyNotification();
          } else {
            console.error("Fallback: comando copy non riuscito");
          }
        } catch (err) {
          console.error("Fallback: impossibile copiare", err);
        }
        document.body.removeChild(textArea);
      }

      // Funzione per copiare la password con fallback su mobile
      function copyPassword() {
        const blocks = document.querySelectorAll("#Pw-display .Block");
        const password = Array.from(blocks)
          .map((block) => block.textContent)
          .filter((text) => text !== "")
          .join("-");
        if (password) {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard
              .writeText(password)
              .then(() => {
                showCopyNotification();
              })
              .catch((err) => {
                // Se la copia con l'API moderna fallisce, uso il fallback
                fallbackCopyTextToClipboard(password);
              });
          } else {
            // Se l'API moderna non è supportata, uso il fallback
            fallbackCopyTextToClipboard(password);
          }
        }
      }

      // Listener per input da tastiera (globale)
      document.addEventListener("keydown", function (e) {
        // Verifica se il dispositivo è desktop (senza touch)
        const isDesktop = !("ontouchstart" in window);
        let newLevel = currentLevel;
        if (e.key === "ArrowUp" || e.key === "Up") {
          e.preventDefault();
          if (window.innerWidth < 576) {
            newLevel = currentLevel - 1;
          } else {
            newLevel = currentLevel + 1;
          }
        } else if (e.key === "ArrowDown" || e.key === "Down") {
          e.preventDefault();
          if (window.innerWidth < 576) {
            newLevel = currentLevel + 1;
          } else {
            newLevel = currentLevel - 1;
          }
        } else if (e.key === "ArrowRight" || e.key === "Right") {
          e.preventDefault();
          newLevel = currentLevel + 1;
        } else if (e.key === "ArrowLeft" || e.key === "Left") {
          e.preventDefault();
          newLevel = currentLevel - 1;
        } else if (e.key === "Enter") {
          // Su desktop, premendo Invio copia la password (indipendentemente dalla viewport)
          if (isDesktop) {
            e.preventDefault();
            copyPassword();
          }
        }
        if (newLevel !== currentLevel) {
          moveSliderToLevel(newLevel);
        }
      });

      // Listener per il div#Copy: uso pointerup per coprire sia click che touch
      const copyDiv = document.getElementById("Copy");
      copyDiv.addEventListener("pointerup", function (e) {
        e.preventDefault();
        copyPassword();
      });
      // Per sicurezza anche click e keydown (Invio)
      copyDiv.addEventListener("click", copyPassword);
      copyDiv.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          copyPassword();
        }
      });

      window.addEventListener("resize", setInitialPosition);
      slider.addEventListener("mousedown", dragStart);
      slider.addEventListener("touchstart", dragStart, { passive: false });
      modeButton.addEventListener("click", () => {
        console.log(modeButton.checked);
      });

      // Inizializza la posizione dello slider e la visualizzazione della password
      setInitialPosition();
    </script>
  </body>
</html>