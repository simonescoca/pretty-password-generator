<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Password Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Courier+Prime&display=swap" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />
    <style>
      /* Modifica: background in light mode */
      body {
        background-color: #D2F4FF;
      }
      header > .container {
        height: 100px;
      }
      header h1#Title {
        font-family: "Audiowide", serif;
        font-weight: 400;
        font-style: normal;
      }
      header #Switch-container {
        height: 40px;
        width: 70px;
        cursor: pointer;
        background: #96e6ff;
        box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.1);
        transition: background 0.3s ease;
        border: 1px solid #0093c0;
      }
      header #Switch {
        height: 35px;
        width: 35px;
        position: absolute;
        background: #fed87d;
        /* Il secondo box-shadow sostituisce il precedente */
        box-shadow: 0px 0px 10px 6px #c9a13fbf;
        left: 1.5px;
        top: 50%;
        transform: translateY(-50%);
        transition: transform 0.3s ease;
      }
      body.dark-mode header #Switch-container {
        background: #201c49;
        box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.3);
        border: 1px solid #bfbaff;
      }
      body.dark-mode header #Switch {
        transform: translateX(calc(100% - 5px)) translateY(-50%);
        background: #bebbe0;
        box-shadow: 0px 0px 10px 3.5px #bfbaffb0;
      }
      main > .container {
        height: calc(100vh - 4rem - 150px);
      }
      main #Slider-pill {
        border: 2px solid #44398d;
        box-shadow: -4px 4px 8px 0px #44398d;
      }
      body.dark-mode main #Slider-pill {
        border-color: #bfbaff;
        box-shadow: 0px 0px 18px 0px #9f9bba;
      }
      #Slider-pill .rounded-circle {
        width: 66px;
        height: 66px;
      }
      main #Slider-pill #Copy {
        background-color: #8e84ff;
        color: #ffffff;
        font-size: 25px;
        transition: all 0.2s ease;
      }
      /* Effetto :active per Copy e per Slider */
      #Slider.active {
        transform: scale(80%);
      }
      main #Slider-pill #Slider {
        background-color: #5445cb;
        color: #ffffff;
        font-size: 25px;
        transition: all 0.1s ease;
      }
      #Slider i.position-absolute {
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      main #Slider-pill #Pw-display {
        font-family: "Courier Prime", monospace;
        font-size: 21px;
      }
      /* Forza il colore del testo di #Pw-display sempre a #44398D */
      #Pw-display {
        color: #44398D !important;
      }
      #Pw-display .Block.has-next::after {
        content: " ";
        display: table;
        position: absolute;
        background-color: #44398D;
        height: 1.7px;
        width: 10px;
        border-radius: 1px;
      }
      #Ticks-container {
        pointer-events: none;
      }
      #Ticks-container .tick {
        background-color: #44398d;
        position: absolute;
        z-index: 1;
      }
      body.dark-mode #Ticks-container .tick {
        background-color: #bfbaff;
      }
      @media screen and (max-width: 575px) {
        #Slider-pill {
          height: 100%;
          width: 70px;
        }
        #Pw-display {
          height: calc(100% - 132px);
          width: 100%;
        }
        #Pw-display .Block {
          width: 100%;
          height: 20%;
        }
        #Pw-display .Block.has-next::after {
          bottom: -1px;
          left: 50%;
          transform: translate(-50%, 50%);
        }
        #Ticks-container .tick {
          width: 6px;
          height: 1px;
        }
      }
      @media screen and (min-width: 576px) {
        #Slider-pill {
          height: 70px;
          width: 100%;
        }
        #Pw-display {
          width: calc(100% - 132px);
          height: 100%;
        }
        #Pw-display .Block {
          height: 100%;
          width: 20%;
        }
        #Pw-display .Block.has-next::after {
          right: -1px;
          top: 50%;
          transform: translate(50%, -50%);
        }
        #Ticks-container .tick {
          height: 6px;
          width: 1px;
        }
      }
      @media screen and (min-width: 768px) {
        #Slider-pill {
          width: 560px;
        }
      }
      #copyNotification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #d4edda;
        color: #155724;
        padding: 10px 20px;
        border-radius: 5px;
        border: 1px solid #c3e6cb;
        display: none;
        z-index: 9999;
        font-family: Arial, sans-serif;
        font-size: 16px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }
      body.dark-mode {
        background-color: #2e2672;
        color: #e0e0e0;
      }
      body.dark-mode #copyNotification {
        background: #155724;
        color: #d4edda;
        border-color: #0c3318;
      }
      body:not(.dark-mode) h1#Title {
        color: #5344CA;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="d-flex container justify-content-between align-items-center mt-3">
        <h1 id="Title">Password Generator</h1>
        <div>
          <label id="Switch-container" for="Mode-button" class="rounded-pill position-relative">
            <div id="Switch" class="rounded-circle d-flex justify-content-center align-items-center position-absolute"></div>
          </label>
          <input type="checkbox" id="Mode-button" class="d-none" />
        </div>
      </div>
    </header>
    <main>
      <div class="d-flex container mt-1 mt-sm-5">
        <div
          id="Slider-pill"
          class="m-auto mx-sm-auto mt-sm-3 rounded-pill d-flex flex-column flex-sm-row justify-content-between align-items-center position-relative"
        >
          <div id="Ticks-container" class="position-absolute w-100 h-100"></div>
          <div id="Copy" class="rounded-circle d-flex justify-content-center align-items-center">
            <i class="fa-regular fa-copy"></i>
          </div>
          <div id="Pw-display" class="d-sm-flex">
            <section class="Block d-flex justify-content-center align-items-center position-relative"></section>
            <section class="Block d-flex justify-content-center align-items-center position-relative"></section>
            <section class="Block d-flex justify-content-center align-items-center position-relative"></section>
            <section class="Block d-flex justify-content-center align-items-center position-relative"></section>
            <section class="Block d-flex justify-content-center align-items-center position-relative"></section>
          </div>
          <div class="rounded-circle"></div>
          <div id="Slider" class="rounded-circle position-absolute d-flex justify-content-center align-items-center">
            <!-- L'icona verrÃ  inserita via JavaScript -->
          </div>
        </div>
      </div>
    </main>
    <div id="copyNotification">
      <i class="fas fa-check" style="margin-right: 8px;"></i> Password copiata
    </div>
    <script>
      // Elementi DOM e variabili globali
      const slider = document.getElementById("Slider");
      const sliderPill = document.getElementById("Slider-pill");
      const modeButton = document.getElementById("Mode-button");
      const copyDiv = document.getElementById("Copy");  // Spostato qui per essere subito disponibile

      let currentLevel = 0;
      let isDragging = false;
      let dragAxis = window.innerWidth < 576 ? "vertical" : "horizontal";
      let startPointerPos = 0;
      let startSliderPos = 0;
      let initialLevel = 0;
      let hasCrossedBoundary = false;

      // Funzione per aggiornare il colore di sfondo del "pill"
      function updatePillBackground(level, darkmode) {
        const colors = [
          "#1D1941", // 0 dark
          "#CAC7FE", // 0 light
          "#FF4848", // livello 1
          "#FDFD5F", // livello 2
          "#85FF7D", // livello 3
          "#5DFF54", // livello 4
          "#10FF03"  // livello 5
        ];
        let color;
        if (level === 0) {
          color = darkmode ? colors[0] : colors[1];
        } else {
          color = colors[level + 1];
        }
        sliderPill.style.backgroundColor = color;
        slider.style.borderColor = color;
      }

      // Funzione per aggiornare lo stato del pulsante "Copy" in base al livello corrente
      function copyButtonHandler() {
        if (currentLevel === 0) {
          copyDiv.style.transform = "scale(0)";
        } else {
          copyDiv.style.transform = "scale(1)";
        }
      }

      // Crea le tacche (ticks) nello slider
      function createTicks() {
        const ticksContainer = document.getElementById("Ticks-container");
        ticksContainer.innerHTML = "";
        const snaps = getSnapPositions();
        const isHorizontal = dragAxis === "horizontal";
        let i = 0;
        snaps.forEach((pos) => {
          const tick1 = document.createElement("div");
          const tick2 = document.createElement("div");
          tick1.className = tick2.className = "tick";

          if (isHorizontal) {
            tick1.style.cssText = `left: ${pos + 33}px; top: 0;`;
            tick2.style.cssText = `left: ${pos + 33}px; bottom: 0;`;
          } else {
            tick1.style.cssText = `top: ${pos + 33}px; left: 0;`;
            tick2.style.cssText = `top: ${pos + 33}px; right: 0;`;
          }

          if (i !== 0) {
            ticksContainer.appendChild(tick1);
            ticksContainer.appendChild(tick2);
          }
          i++;
        });
      }

      // Funzione per generare un indice casuale
      function genRandomIndex(len) {
        const arr = new Uint32Array(1);
        window.crypto.getRandomValues(arr);
        return arr[0] % len;
      }

      // Genera la password in base al livello
      function generatePw(level) {
        const ABC = "ABCDEFGHJKLMNPQRSTUVWXYZ".split("");
        const abc = "abcdefghijkmnopqrstuvwxyz".split("");
        const nums = "0123456789".split("");
        const chars = "!@#$%&*?.".split("");
        let password, checkCap, checkLow, checkNum, checkSC;
        do {
          password = "";
          checkCap = checkLow = checkNum = checkSC = false;
          for (let i = 0; i < 4 * level; i++) {
            const boundary = i % 4 === 0 || i % 4 === 3;
            const options = boundary
              ? [
                  ABC[genRandomIndex(ABC.length)],
                  abc[genRandomIndex(abc.length)],
                  nums[genRandomIndex(nums.length)]
                ]
              : [
                  ABC[genRandomIndex(ABC.length)],
                  abc[genRandomIndex(abc.length)],
                  nums[genRandomIndex(nums.length)],
                  chars[genRandomIndex(chars.length)]
                ];
            const chosen = options[genRandomIndex(options.length)];
            password += chosen;
            if (ABC.includes(chosen)) checkCap = true;
            if (abc.includes(chosen)) checkLow = true;
            if (nums.includes(chosen)) checkNum = true;
            if (chars.includes(chosen)) checkSC = true;
          }
        } while (!(checkCap && checkLow && checkNum && checkSC));
        return password.match(/.{1,4}/g).join("-");
      }

      // Aggiorna la visualizzazione della password e dello slider
      function updatePasswordDisplay(level) {
        updatePillBackground(level, document.body.classList.contains("dark-mode"));
        const pwDisplay = document.getElementById("Pw-display");
        const blocks = pwDisplay.querySelectorAll(".Block");

        blocks.forEach((block) => {
          block.textContent = "";
          block.classList.remove("has-next");
        });

        if (level === 0) {
          updateSliderIcon();
          copyButtonHandler();
          return;
        }

        const password = generatePw(level);
        const groups = password.split("-");

        blocks.forEach((block, index) => {
          if (index < groups.length) {
            block.textContent = groups[index];
            if (blocks[index + 1] && groups[index + 1]) {
              block.classList.add("has-next");
            }
          }
        });
        updateSliderIcon();
        copyButtonHandler();
      }

      // Aggiorna l'icona dello slider in base al livello corrente
      function updateSliderIcon() {
        let iconClass = "",
          iconClassI = "",
          iconClassII = "";
        if (currentLevel === 0 || currentLevel === 5) {
          if (window.innerWidth < 576) {
            iconClass = currentLevel === 0 ? "fa-arrow-down-long" : "fa-arrow-up-long";
          } else {
            iconClass = currentLevel === 0 ? "fa-arrow-right-long" : "fa-arrow-left-long";
          }
          slider.innerHTML = `<i class="fa-solid ${iconClass} position-absolute"></i>`;
        } else {
          if (window.innerWidth < 576) {
            iconClassI = "fa-arrow-down-long";
            iconClassII = "fa-arrow-up-long";
          } else {
            iconClassI = "fa-arrow-right-long";
            iconClassII = "fa-arrow-left-long";
          }
          slider.innerHTML = `<i class="fa-solid ${iconClassI} position-absolute"></i><i class="fa-solid ${iconClassII} position-absolute"></i>`;
        }
      }

      // Imposta la posizione iniziale dello slider
      function setInitialPosition() {
        dragAxis = window.innerWidth < 576 ? "vertical" : "horizontal";
        slider.style.top = "0px";
        slider.style.left = "0px";
        currentLevel = 0;
        updatePasswordDisplay(0);
      }

      // Restituisce la posizione del puntatore (mouse o touch)
      function getPointerPosition(e) {
        return e.touches
          ? { x: e.touches[0].clientX, y: e.touches[0].clientY }
          : { x: e.clientX, y: e.clientY };
      }

      // Calcola le posizioni di snap per lo slider
      function getSnapPositions() {
        const pillRect = sliderPill.getBoundingClientRect();
        const blocks = document.querySelectorAll("#Pw-display .Block");
        let snaps = [0];

        blocks.forEach((block) => {
          const blockRect = block.getBoundingClientRect();
          snaps.push(
            dragAxis === "vertical"
              ? blockRect.bottom - pillRect.top - 2
              : blockRect.right - pillRect.left - 2
          );
        });
        return snaps;
      }

      // Determina il livello corrente in base alla posizione dello slider
      function calculateCurrentLevel(currentPos, snaps) {
        let level = 0;
        for (let i = snaps.length - 1; i >= 0; i--) {
          if (snaps[i] <= currentPos) {
            level = i;
            break;
          }
        }
        return level;
      }

      // Inizio del drag dello slider
      function dragStart(e) {
        slider.classList.add("active");
        e.preventDefault();
        isDragging = true;
        initialLevel = currentLevel;
        hasCrossedBoundary = false;
        dragAxis = window.innerWidth < 576 ? "vertical" : "horizontal";
        const pointerPos = getPointerPosition(e);
        const sliderPos =
          dragAxis === "vertical"
            ? parseInt(slider.style.top) || 0
            : parseInt(slider.style.left) || 0;
        startPointerPos = dragAxis === "vertical" ? pointerPos.y : pointerPos.x;
        startSliderPos = sliderPos;

        document.addEventListener("mousemove", dragMove);
        document.addEventListener("mouseup", dragEnd);
        document.addEventListener("touchmove", dragMove, { passive: false });
        document.addEventListener("touchend", dragEnd);
      }

      // Durante il drag dello slider
      function dragMove(e) {
        if (!isDragging) return;
        e.preventDefault();
        const pointerPos = getPointerPosition(e);
        const delta =
          dragAxis === "vertical"
            ? pointerPos.y - startPointerPos
            : pointerPos.x - startPointerPos;
        let newPos = startSliderPos + delta;
        const snaps = getSnapPositions();
        newPos = Math.max(snaps[0], Math.min(snaps[snaps.length - 1], newPos));

        const targetLevel = calculateCurrentLevel(newPos, snaps);
        if (targetLevel !== currentLevel) {
          hasCrossedBoundary = true;
          currentLevel = targetLevel;
          updatePasswordDisplay(currentLevel);
        }

        if (dragAxis === "vertical") {
          slider.style.top = newPos + "px";
        } else {
          slider.style.left = newPos + "px";
        }
      }

      // Fine del drag dello slider
      function dragEnd(e) {
        slider.classList.remove("active");
        isDragging = false;
        ["mousemove", "mouseup", "touchmove", "touchend"].forEach((event) =>
          document.removeEventListener(event, dragEnd)
        );

        const snaps = getSnapPositions();
        const currentPos =
          dragAxis === "vertical"
            ? parseInt(slider.style.top) || 0
            : parseInt(slider.style.left) || 0;

        let closestIndex = 0;
        snaps.forEach((snap, index) => {
          if (Math.abs(snap - currentPos) < Math.abs(snaps[closestIndex] - currentPos)) {
            closestIndex = index;
          }
        });

        if (closestIndex !== currentLevel || (closestIndex === initialLevel && hasCrossedBoundary)) {
          currentLevel = closestIndex;
          updatePasswordDisplay(currentLevel);
        }

        if (dragAxis === "vertical") {
          slider.style.top = snaps[closestIndex] + "px";
        } else {
          slider.style.left = snaps[closestIndex] + "px";
        }
      }

      // Sposta lo slider ad un livello specifico
      function moveSliderToLevel(newLevel) {
        const snaps = getSnapPositions();
        newLevel = Math.max(0, Math.min(snaps.length - 1, newLevel));
        if (dragAxis === "vertical") {
          slider.style.top = snaps[newLevel] + "px";
        } else {
          slider.style.left = snaps[newLevel] + "px";
        }
        currentLevel = newLevel;
        updatePasswordDisplay(newLevel);
      }

      // Copia la password negli appunti
      function copyPassword() {
        const password = Array.from(document.querySelectorAll("#Pw-display .Block"))
          .map((block) => block.textContent)
          .filter((text) => text)
          .join("-");
        if (!password) return;
        if (navigator.clipboard?.writeText) {
          navigator.clipboard.writeText(password)
            .then(showCopyNotification)
            .catch(() => {}); // Supponiamo di voler sopprimere l'errore in console
        } else {
          const textArea = document.createElement("textarea");
          textArea.value = password;
          textArea.style.position = "fixed";
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand("copy") && showCopyNotification();
          } catch (e) {}
          document.body.removeChild(textArea);
        }
      }

      // Mostra la notifica di copia
      function showCopyNotification() {
        const notif = document.getElementById("copyNotification");
        notif.style.display = "block";
        setTimeout(() => (notif.style.display = "none"), 2000);
      }

      // Gestione del tema dark/light
      function modeLogic() {
        // Toggle della classe dark-mode in base allo stato del checkbox
        document.body.classList.toggle("dark-mode", modeButton.checked);
        // Aggiorna subito il colore di sfondo della slider pill in base al tema corrente
        updatePillBackground(currentLevel, modeButton.checked);
      }

      // *** FUNZIONI AGGIORNATE PER IL RESIZE ***

      // setPosition: riposiziona lo slider in base al livello salvato e alle nuove dimensioni
      function setPosition(level) {
        dragAxis = window.innerWidth < 576 ? "vertical" : "horizontal";
        const snaps = getSnapPositions();
        level = Math.max(0, Math.min(snaps.length - 1, level));
        if (dragAxis === "vertical") {
          slider.style.top = snaps[level] + "px";
          slider.style.left = "0px";
          slider.style.right = "0px";
        } else {
          slider.style.left = snaps[level] + "px";
          slider.style.top = "0px";
          slider.style.bottom = "0px";
        }
        currentLevel = level;
        updateSliderIcon();
      }

      // setPassword: ripristina la visualizzazione della password salvata
      function setPassword(password) {
        if (!password) return;
        const pwDisplay = document.getElementById("Pw-display");
        const blocks = pwDisplay.querySelectorAll(".Block");
        const groups = password.split("-");
        blocks.forEach((block, index) => {
          if (index < groups.length) {
            block.textContent = groups[index];
            if (index < groups.length - 1) {
              block.classList.add("has-next");
            } else {
              block.classList.remove("has-next");
            }
          } else {
            block.textContent = "";
            block.classList.remove("has-next");
          }
        });
      }

      // Funzione handleResize: salva il livello e la password visualizzata prima del resize
      function handleResize() {
        const saveCurrentLevel = currentLevel;
        const saveCurrentPassword = Array.from(document.querySelectorAll("#Pw-display .Block"))
          .map((block) => block.textContent)
          .filter((text) => text)
          .join("-");
        return {
          savedLevel: saveCurrentLevel,
          savedPassword: saveCurrentPassword
        };
      }

      // Gestione della pressione dei tasti per cambiare livello o copiare
      document.addEventListener("keydown", (e) => {
        const isDesktop = !("ontouchstart" in window);
        let newLevel = currentLevel;
        switch (e.key) {
          case "ArrowUp":
          case "Up":
            newLevel = window.innerWidth < 576 ? currentLevel - 1 : currentLevel + 1;
            break;
          case "ArrowDown":
          case "Down":
            newLevel = window.innerWidth < 576 ? currentLevel + 1 : currentLevel - 1;
            break;
          case "ArrowRight":
          case "Right":
            newLevel++;
            break;
          case "ArrowLeft":
          case "Left":
            newLevel--;
            break;
          case "Enter":
            if (isDesktop) copyPassword();
            break;
        }
        if (newLevel !== currentLevel) moveSliderToLevel(newLevel);
      });

      // Gestione del border-color dello #Slider
      document.addEventListener("keydown", (e) => {
        const possibleKeys = ["ArrowUp", "Up", "ArrowDown", "Down", "ArrowRight", "Right", "ArrowLeft", "Left"];
        possibleKeys.forEach(key => {
          if (key === e.key) slider.classList.add("active");
        });
      });

      // Gestione del border-color dello #Slider
      document.addEventListener("keyup", (e) => {
        const possibleKeys = ["ArrowUp", "Up", "ArrowDown", "Down", "ArrowRight", "Right", "ArrowLeft", "Left"];
        possibleKeys.forEach(key => {
          if (key === e.key) slider.classList.remove("active");
        });
      });

      // Event listeners per copia e tema
      document.addEventListener("keydown", (e) => {
        if (e.key === "Enter") copyDiv.classList.add("active");
      });

      document.addEventListener("keyup", (e) => {
        if (e.key === "Enter") copyDiv.classList.remove("active");
      });

      copyDiv.addEventListener("pointerdown", () => {copyDiv.style.transform = "scale(80%)"});
      copyDiv.addEventListener("pointerup", () => {copyDiv.style.transform = "scale(100%)"});
      copyDiv.addEventListener("pointerup", copyPassword);
      copyDiv.addEventListener("click", copyPassword);
      // Nuovi event handler per simulare l'effetto :active quando si preme Invio
      copyDiv.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          copyDiv.classList.add("active");
          copyPassword();
        }
      });
      copyDiv.addEventListener("keyup", (e) => {
        if (e.key === "Enter") {
          copyDiv.classList.remove("active");
        }
      });
      modeButton.addEventListener("change", modeLogic);

      // Gestione del resize: riposiziona lo slider e ripristina la password salvata
      window.addEventListener("resize", () => {
        if (currentLevel != 0) {
          const savedState = handleResize();
          setPosition(savedState.savedLevel);
          setPassword(savedState.savedPassword);
        } else {
          setInitialPosition();
        }
      });

      window.addEventListener("resize", createTicks);

      // Event listeners per il drag dello slider
      slider.addEventListener("mousedown", dragStart);
      slider.addEventListener("touchstart", dragStart, { passive: false });

      // Inizializzazione
      document.addEventListener("DOMContentLoaded", () => {
        modeLogic();
        setInitialPosition();
        createTicks();
      });
    </script>
  </body>
</html>